# Supabase Auth Integration for Admin Portal

This document explains how the admin portal integrates with Supabase Authentication for user management.

## Overview

The integration allows admin users to create new user accounts that are properly synchronized between:

1. **Supabase Authentication** - For secure login and authentication
2. **Accounts Table** - For application-specific user data

The implementation ensures data consistency by:
- Using the Supabase Auth UUID as the primary key in the accounts table
- Not storing passwords in the accounts table (only in Auth)
- Handling errors properly (e.g., deleting Auth users if account creation fails)

## Setup Requirements

### 1. Environment Variables

Add the following to your `.env` file:

```
VITE_SUPABASE_URL=your_supabase_project_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
VITE_SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
```

> **IMPORTANT**: The service role key has admin privileges. Never expose it to the client side or in public repositories.

### 2. Database Schema

Ensure your `accounts` table in Supabase has the following structure:

```sql
CREATE TABLE accounts (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  username TEXT NOT NULL,
  role TEXT NOT NULL,
  school_id UUID,
  grade_levels TEXT[],
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_login TIMESTAMP WITH TIME ZONE
);
```

## How It Works

### User Creation Flow

1. Admin fills out the account creation form with user details
2. The system creates a new user in Supabase Auth using the admin API
3. The system then creates a new record in the accounts table using the Auth UUID
4. If any step fails, the system rolls back changes to maintain consistency

### Technical Implementation

The integration uses:

- `supabaseAdmin.ts` - Service with admin API functions using the service role key
- `AccountForm.tsx` - Updated to handle the integrated user creation flow
- `hybridApi.ts` - Modified to handle Auth-linked account creation

## Fallback Mechanism

If the Supabase Admin API is not configured (missing service role key), the system falls back to the previous implementation using local storage.

## Security Considerations

- The service role key should only be used in secure environments
- Passwords are never stored in the accounts table, only in Supabase Auth
- User UUIDs are generated by Supabase Auth, ensuring proper security

## Troubleshooting

If you encounter issues:

1. Check that all environment variables are properly set
2. Verify that the accounts table schema matches the requirements
3. Check browser console logs for detailed error messages
4. Ensure the service role key has proper permissions in Supabase