import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { Plus, Edit, Filter, CreditCard, Check, Clock, MessageSquare, Download, Upload, User, ChevronDown, ChevronRight, Trash2, Calendar, FileText } from 'lucide-react';
import { useAuth } from '../../../contexts/AuthContext';
import { CURRENCY } from '../../../utils/constants';
import pdfPrinter from '../../../services/pdfPrinter';
import dataStore from '../../../services/dataStore';
import { v4 as uuidv4 } from 'uuid';
import { generateReceiptNumber } from '../../../utils/helpers';
import ImportDialog from '../../../components/ImportDialog';
import { generateInstallmentTemplateCSV, exportInstallmentsToCSV } from '../../../services/importExport';
import DownloadPrintButtons from '../../../components/DownloadPrintButtons';

// Format phone number - preserve as entered
const formatPhoneNumber = (phone: string): string => {
  if (!phone) return '';
  
  // Just trim and return as is
  return phone.trim();
};



interface Student {
  id: string;
  name: string;
  grade: string;
  installments: Installment[];
  totalAmount: number;
  totalPaid: number;
  totalDue: number;
}

interface Installment {
  id: string;
  studentId: string;
  studentName: string;
  grade: string;
  amount: number;
  paidAmount?: number;
  dueDate: string;
  paidDate: string | null;
  status: 'paid' | 'upcoming' | 'overdue' | 'partial';
  feeId: string;
  feeType: string;
  note?: string;
  schoolId: string;
  installmentCount: number;
  installmentMonth?: string;
  createdAt?: string;
  updatedAt?: string;
}

// Fix the type issues with installments
interface DataStoreInstallment {
  id: string;
  studentId: string;
  studentName: string;
  grade: string;
  amount: number;
  paidAmount?: number;
  dueDate: string;
  paidDate: string | null;
  status: 'paid' | 'upcoming' | 'overdue' | 'partial';
  feeId: string;
  feeType: string;
  note?: string;
  schoolId: string;
  installmentCount?: number;
  installmentMonth?: string;
  createdAt?: string;
  updatedAt?: string;
}

const Installments = () => {
  const { user } = useAuth();
  const [installments, setInstallments] = useState<Installment[]>([]);
  const [students, setStudents] = useState<Student[]>([]);
  const [filteredStudents, setFilteredStudents] = useState<Student[]>([]);
  const [selectedGrade, setSelectedGrade] = useState<string>('all');
  const [selectedStatus, setSelectedStatus] = useState<string>('all');
  const [selectedMonth, setSelectedMonth] = useState<string>('all');
  const [isLoading, setIsLoading] = useState(true);
  const [expandedStudents, setExpandedStudents] = useState<Record<string, boolean>>({});
  const [displayMode, setDisplayMode] = useState<'student' | 'list'>('student');
  const [selectedInstallments, setSelectedInstallments] = useState<Record<string, boolean>>({});
  const [selectAllChecked, setSelectAllChecked] = useState<Record<string, boolean>>({});
  const [showCustomPayment, setShowCustomPayment] = useState(false);
  const [selectedInstallmentId, setSelectedInstallmentId] = useState<string | null>(null);
  const [customAmount, setCustomAmount] = useState<number>(0);
  const [showTemplateDialog, setShowTemplateDialog] = useState(false);
  const [selectedTemplate, setSelectedTemplate] = useState('');
  const [customTemplate, setCustomTemplate] = useState('');
  const [importDialogOpen, setImportDialogOpen] = useState(false);
  const [importResult, setImportResult] = useState<{studentsCount: number; feesCount: number; installmentsCount?: number} | null>(null);
  const [showMonthFilterDialog, setShowMonthFilterDialog] = useState(false);

  // Add processStudentsData function
  const processStudentsData = (fetchedInstallments: Installment[]) => {
    // Group installments by student
    const studentMap = new Map<string, Student>();
    
    fetchedInstallments.forEach((installment: Installment) => {
      const { studentId, studentName, grade } = installment;
      
      if (!studentMap.has(studentId)) {
        studentMap.set(studentId, {
          id: studentId,
          name: studentName,
          grade,
          installments: [],
          totalAmount: 0,
          totalPaid: 0,
          totalDue: 0
        });
      }
      
      const student = studentMap.get(studentId)!;
      student.installments.push(installment);
    });
    
    // Calculate financial summaries for each student
    studentMap.forEach(student => {
      // Calculate total amount
      student.totalAmount = student.installments.reduce((sum, inst) => sum + inst.amount, 0);
      
      // Calculate total paid based on paidAmount when available
      student.totalPaid = student.installments.reduce((sum, inst) => {
        if (inst.paidDate) {
          return sum + (inst.paidAmount !== undefined ? inst.paidAmount : inst.amount);
        }
        return sum;
      }, 0);
      
      // Calculate total due
      student.totalDue = student.totalAmount - student.totalPaid;
    });
    
    // Convert to array and sort by name
    const studentArray = Array.from(studentMap.values());
    studentArray.sort((a, b) => a.name.localeCompare(b.name));
    
    setStudents(studentArray);
    setFilteredStudents(studentArray);
  };

  // Update the fetchInstallments function to handle the type mismatch
  const fetchInstallments = async () => {
    setIsLoading(true);
    
    try {
      let fetchedInstallments: DataStoreInstallment[] = [];
      if (user?.role === 'gradeManager' && user?.gradeLevels && user.gradeLevels.length > 0) {
        fetchedInstallments = dataStore.getInstallments(user.schoolId, undefined, undefined, user.gradeLevels);
      } else {
        fetchedInstallments = dataStore.getInstallments(user?.schoolId);
      }
      
      // Convert to our Installment type with required installmentCount
      const convertedInstallments: Installment[] = fetchedInstallments.map(inst => ({
        ...inst,
        installmentCount: inst.installmentCount || 1
      }));
      
      setInstallments(convertedInstallments);
      
      // Process students data
      processStudentsData(convertedInstallments);
      
      setIsLoading(false);
    } catch (error) {
      console.error('Error loading installments:', error);
      setIsLoading(false);
    }
  };

  // Update useEffect to use the function
  useEffect(() => {
    // Initial fetch
    fetchInstallments();
    
    // Create a debounced version of fetchInstallments to prevent excessive refreshes
    let refreshTimeout: NodeJS.Timeout | null = null;
    const debouncedFetchInstallments = () => {
      if (refreshTimeout) {
        clearTimeout(refreshTimeout);
      }
      refreshTimeout = setTimeout(() => {
        console.log('Installments component: Data store changed, refreshing...');
        fetchInstallments();
      }, 300); // 300ms debounce
    };
    
    // Subscribe to data store changes with debounce
    const unsubscribe = dataStore.subscribe(() => {
      debouncedFetchInstallments();
    });
    
    // Cleanup subscription and timeout on unmount
    return () => {
      unsubscribe();
      if (refreshTimeout) {
        clearTimeout(refreshTimeout);
      }
    };
  }, [user?.schoolId, user?.role, user?.gradeLevels]);

  // Apply filters whenever installments or filter options change
  useEffect(() => {
    let filteredStuds = students;
    
    if (selectedGrade !== 'all') {
      filteredStuds = filteredStuds.filter((student) => student.grade === selectedGrade);
    }
    
    if (selectedStatus !== 'all') {
      filteredStuds = filteredStuds.filter((student) => {
        // Filter students that have installments matching the selected status
        const hasMatchingInstallments = student.installments.some(inst => {
          if (selectedStatus === 'paid') {
            return inst.status === 'paid';
          } else if (selectedStatus === 'unpaid') {
            return inst.status === 'upcoming';
          } else if (selectedStatus === 'overdue') {
            return inst.status === 'overdue';
          } else if (selectedStatus === 'partial') {
            return inst.status === 'partial';
          }
          return true;
        });
        
        return hasMatchingInstallments;
      });
    }
    
    if (selectedMonth !== 'all') {
      // Define month names once to avoid repetition
      const monthNames = [
        'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
        'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
      ];
      
      filteredStuds = filteredStuds.filter((student) => {
        // Filter students that have installments for the selected month
        // or installments where we can determine the month from the due date
        const hasMatchingMonth = student.installments.some(inst => {
          // Check if installment has explicit month that matches
          if (inst.installmentMonth === selectedMonth) {
            return true;
          }
          
          // If installmentMonth is not set, try to determine it from the due date
          try {
            const dueDate = new Date(inst.dueDate);
            const monthFromDate = monthNames[dueDate.getMonth()];
            return monthFromDate === selectedMonth;
          } catch (e) {
            return false;
          }
        });
        
        return hasMatchingMonth;
      });
      
      // Also filter the installments within each student to only show the selected month
      filteredStuds = filteredStuds.map(student => {
        const filteredInstallments = student.installments.filter(inst => {
          // Check if installment has explicit month that matches
          if (inst.installmentMonth === selectedMonth) {
            return true;
          }
          
          // If installmentMonth is not set, try to determine it from the due date
          try {
            const dueDate = new Date(inst.dueDate);
            const monthFromDate = monthNames[dueDate.getMonth()];
            return monthFromDate === selectedMonth;
          } catch (e) {
            return false;
          }
        });
        
        return {
          ...student,
          installments: filteredInstallments
        };
      });
    }
    
    setFilteredStudents(filteredStuds);
  }, [selectedGrade, selectedStatus, selectedMonth, students]);

  const toggleExpandStudent = (studentId: string) => {
    setExpandedStudents(prev => ({
      ...prev,
      [studentId]: !prev[studentId]
    }));
  };

  const expandAllStudents = () => {
    const expanded: Record<string, boolean> = {};
    students.forEach(student => {
      expanded[student.id] = true;
    });
    setExpandedStudents(expanded);
  };

  const collapseAllStudents = () => {
    setExpandedStudents({});
  };

  const handleMarkAsPaid = (id: string, customAmount?: number) => {
    const installment = dataStore.getInstallment(id);
    if (!installment) return;
    
    // Get the original amount and the payment amount
    const originalAmount = installment.amount;
    
    // If using the pay icon (not custom payment), always mark as fully paid
    const paymentAmount = customAmount !== undefined ? customAmount : originalAmount;
    
    try {
      // Get the parent fee
      const fee = dataStore.getFee(installment.feeId);
      if (!fee) {
        alert('لم يتم العثور على الرسوم المرتبطة بهذا القسط');
        return;
      }
      
      // Temporarily disable notifications to improve performance
      const originalNotifyListeners = dataStore.notifyListeners;
      dataStore.notifyListeners = () => {}; // Replace with no-op function
      
      // Get all installments for this fee
      const allInstallments = dataStore.getInstallments(user?.schoolId, undefined, installment.feeId);
      
      // Calculate previous paid amount (if any)
      const previouslyPaid = installment.paidAmount || 0;
      const totalPaidForThisInstallment = previouslyPaid + paymentAmount;
      
      // Update the current installment based on payment amount
      if (totalPaidForThisInstallment >= originalAmount) {
        // Full payment or overpayment
        dataStore.saveInstallment({
          ...installment,
          paidAmount: originalAmount, // Always set to full amount for the current installment
          paidDate: new Date().toISOString().split('T')[0],
          status: 'paid'
        });
        
        // If there's an overpayment, apply it to the next unpaid installment
        const overpayment = totalPaidForThisInstallment - originalAmount;
        
        if (overpayment > 0) {
          // Find the next unpaid installments
          const unpaidInstallments = allInstallments
            .filter(inst => (inst.status !== 'paid' && inst.id !== id))
            .sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());
          
          let remainingOverpayment = overpayment;
          
          // Apply overpayment to subsequent installments
          for (let i = 0; i < unpaidInstallments.length && remainingOverpayment > 0; i++) {
            const nextInstallment = unpaidInstallments[i];
            const nextInstallmentPreviouslyPaid = nextInstallment.paidAmount || 0;
            const nextInstallmentTotalAfterPayment = nextInstallmentPreviouslyPaid + remainingOverpayment;
            
            // If overpayment covers the full next installment
            if (nextInstallmentTotalAfterPayment >= nextInstallment.amount) {
              dataStore.saveInstallment({
                ...nextInstallment,
                paidAmount: nextInstallment.amount,
                paidDate: new Date().toISOString().split('T')[0],
                status: 'paid'
              });
              
              remainingOverpayment -= (nextInstallment.amount - nextInstallmentPreviouslyPaid);
            } else {
              // Partial payment for next installment
              dataStore.saveInstallment({
                ...nextInstallment,
                paidAmount: nextInstallmentTotalAfterPayment,
                paidDate: new Date().toISOString().split('T')[0],
                status: 'partial'
              });
              
              remainingOverpayment = 0;
            }
          }
        }
      } else {
        // Partial payment
        dataStore.saveInstallment({
          ...installment,
          paidAmount: totalPaidForThisInstallment,
          paidDate: new Date().toISOString().split('T')[0],
          status: 'partial'
        });
      }
      
      // Recalculate total paid amount for the fee
      const updatedInstallments = dataStore.getInstallments(user?.schoolId, undefined, fee.id);
      const totalPaid = updatedInstallments.reduce((sum, inst) => {
        // Use paidAmount if available, otherwise use amount for paid installments
        if (inst.paidDate) {
          return sum + (inst.paidAmount !== undefined ? inst.paidAmount : inst.amount);
        }
        return sum;
      }, 0);
      
      // Calculate remaining amount after discount
      const totalAmount = fee.amount - fee.discount;
      const remainingAmount = Math.max(0, totalAmount - totalPaid);
      
      // Update fee status
      let updatedStatus: 'paid' | 'partial' | 'unpaid' = 'unpaid';
      if (remainingAmount <= 0) {
        updatedStatus = 'paid';
      } else if (totalPaid > 0) {
        updatedStatus = 'partial';
      }
      
      // Save the updated fee
      dataStore.saveFee({
        ...fee,
        paid: Math.min(totalPaid, totalAmount), // Ensure paid amount doesn't exceed total after discount
        balance: remainingAmount,
        status: updatedStatus
      });
      
      // Restore the original notifyListeners function and trigger a single update
      dataStore.notifyListeners = originalNotifyListeners;
      dataStore.notifyListeners();
      
    } catch (error) {
      console.error('Error updating payment:', error);
      alert('حدث خطأ أثناء تحديث الدفعة');
    }
  };
  
  const handlePrintReceipt = (id: string) => {
    const installment = dataStore.getInstallment(id);
    if (!installment) {
      alert('لم يتم العثور على القسط');
      return;
    }
    
    if (!installment.paidDate) {
      alert('لا يمكن طباعة إيصال لقسط غير مدفوع');
      return;
    }
    
    try {
      // Get student information
      const student = dataStore.getStudent(installment.studentId);
      if (!student) {
        alert('لم يتم العثور على الطالب');
        return;
      }
      
      // Get fee information
      const fee = dataStore.getFee(installment.feeId);
      if (!fee) {
        alert('لم يتم العثور على الرسوم المرتبطة');
        return;
      }
      
      // Get school settings
      const schoolSettings = dataStore.getSettings(user?.schoolId || '');
      
      // Generate receipt number
      let receiptNumber = '';
      if (schoolSettings.receiptNumberFormat === 'sequential') {
        receiptNumber = (schoolSettings.receiptNumberCounter || 1).toString().padStart(4, '0');
      } else if (schoolSettings.receiptNumberFormat === 'year') {
        const year = new Date().getFullYear();
        receiptNumber = `${schoolSettings.receiptNumberCounter || 1}/${year}`;
      } else if (schoolSettings.receiptNumberFormat === 'short-year') {
        const year = new Date().getFullYear().toString().slice(-2);
        receiptNumber = `${schoolSettings.receiptNumberCounter || 1}/${year}`;
      } else if (schoolSettings.receiptNumberFormat === 'custom') {
        receiptNumber = `${schoolSettings.receiptNumberPrefix}${schoolSettings.receiptNumberCounter || 1}`;
      } else {
        // Default format (auto)
        receiptNumber = `R-${Date.now().toString().slice(-8)}`;
      }
      
      // Fix the receipt counter increment
      if (schoolSettings.receiptNumberFormat !== 'auto') {
        schoolSettings.receiptNumberCounter = (schoolSettings.receiptNumberCounter || 0) + 1;
        dataStore.saveSettings(user?.schoolId || '', schoolSettings);
      }
      
      // Prepare receipt data
      const receiptData = {
        receiptNumber: receiptNumber,
        date: installment.paidDate || new Date().toISOString().split('T')[0],
        studentName: installment.studentName,
        studentId: student.studentId, // Always use the assigned student ID
        grade: installment.grade,
        feeType: `${getFeeTypeLabel(installment.feeType)} - قسط ${installment.installmentCount}`,
        amount: installment.paidAmount || installment.amount,
        schoolName: schoolSettings.name || user?.schoolName || '',
        schoolLogo: schoolSettings.logo || user?.schoolLogo || '',
        schoolPhone: schoolSettings.phone || '',
        schoolPhoneWhatsapp: schoolSettings.phoneWhatsapp || '',
        schoolPhoneCall: schoolSettings.phoneCall || '',
        schoolEmail: schoolSettings.email || '',
        showWatermark: schoolSettings.showReceiptWatermark,
        showLogoBackground: schoolSettings.showLogoBackground
      };
      
      // Generate and print receipt
      pdfPrinter.printReceipt(receiptData);
    } catch (error) {
      console.error('Error generating receipt:', error);
      alert('حدث خطأ أثناء إنشاء الإيصال. يرجى المحاولة مرة أخرى.');
    }
  };

  const handleSendReminder = async (id: string) => {
    const installment = dataStore.getInstallment(id);
    if (!installment) return;
    
    try {
      // Get student to get the phone number
      const student = dataStore.getStudent(installment.studentId);
      if (!student) {
        alert('لم يتم العثور على بيانات الطالب');
        return;
      }

      // Get available templates
      const templates = dataStore.getTemplates();
      
      // Create default template if none exists
      if (!templates || templates.length === 0) {
        const defaultTemplate = {
          id: 'default',
          name: 'تذكير بالقسط',
          content: `نفيدكم بأن القسط المستحق على الطالب {studentName} بمبلغ {amount} {currency} مستحقة بتاريخ {dueDate}، نرجو دفع المستحقات في اقرب فرصة ممكنة.`
        };
        dataStore.saveTemplate(defaultTemplate);
      }

      // Show template selection dialog
      setSelectedInstallmentId(id);
      setShowTemplateDialog(true);
      
    } catch (error) {
      console.error('Error preparing reminder:', error);
      alert('حدث خطأ أثناء إعداد التذكير');
    }
  };
  
  const handleExportInstallments = () => {
    try {
      // Generate CSV content with color coding for Excel
      const csvContent = exportInstallmentsToCSV(user?.schoolId || '');
      
      // Create a blob and download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'قائمة_الأقساط_ملونة.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // Show success message
      alert('تم تصدير البيانات بنجاح. عند فتح الملف في Excel، ستظهر الألوان والحسابات تلقائياً.');
    } catch (error) {
      console.error('Error exporting installments:', error);
      alert('حدث خطأ أثناء تصدير الأقساط');
    }
  };
  
  const handleImportSuccess = (result: {studentsCount: number; feesCount: number; installmentsCount?: number}) => {
    setImportResult(result);
    console.log('Import successful, refreshing data:', result);
    
    // Close the import dialog
    setImportDialogOpen(false);
    
    // Show a notification to the user
    if (result.installmentsCount && result.installmentsCount > 0) {
      alert(`تم استيراد ${result.installmentsCount} قسط بنجاح`);
    }
    
    // Force refresh data with multiple attempts
    fetchInstallments();
    
    // Schedule additional refreshes with delays to ensure data is loaded
    setTimeout(() => {
      fetchInstallments();
      
      setTimeout(() => {
        fetchInstallments();
      }, 500);
    }, 300);
  };

  // Fix the handlePrintStudentReport function to avoid using properties that don't exist on the Settings type
  const handlePrintStudentReport = (studentId: string) => {
    const student = dataStore.getStudent(studentId);
    if (!student) return;
    
    // Get all installments for this student
    const studentInstallments = installments.filter(i => i.studentId === studentId);
    
    // Get school settings
    const schoolSettings = dataStore.getSettings(user?.schoolId || '');
    
    // Create properly typed mapped installments
    const mappedInstallments = studentInstallments.map(inst => ({
      id: inst.id,
      feeType: inst.feeType,
      amount: inst.amount,
      paidAmount: inst.paidAmount,
      dueDate: inst.dueDate,
      paidDate: inst.paidDate,
      status: inst.status,
      installmentCount: inst.installmentCount,
      installmentMonth: inst.installmentMonth,
      discount: undefined // Add missing field required by StudentInstallmentsReportData
    }));
    
    // Create report data with properly typed installments
    const reportData = {
      studentName: student.name,
      studentId: student.studentId,
      grade: student.grade,
      installments: mappedInstallments,
      schoolName: schoolSettings.name || user?.schoolName || '',
      schoolLogo: schoolSettings.logo || '',
      schoolPhone: schoolSettings.phone || '',
      schoolPhoneWhatsapp: schoolSettings.phoneWhatsapp || '',
      schoolPhoneCall: schoolSettings.phoneCall || '',
      schoolEmail: schoolSettings.email || '',
      showWatermark: schoolSettings.showStudentReportWatermark,
      showLogoBackground: schoolSettings.showLogoBackground
    };
    
    // Print the installments report
    console.log('Printing student installments report with data:', reportData);
    pdfPrinter.printStudentInstallmentsReport(reportData);
  };

  const getFeeTypeLabel = (type: string): string => {
    const feeTypes: Record<string, string> = {
      'tuition': 'رسوم دراسية',
      'transportation': 'نقل مدرسي',
      'activities': 'أنشطة',
      'uniform': 'زي مدرسي',
      'books': 'كتب',
      'other': 'رسوم أخرى'
    };
    
    return feeTypes[type] || type;
  };

  const getStatusLabel = (status: string) => {
    switch (status) {
      case 'paid':
        return 'مدفوع';
      case 'upcoming':
        return 'الدفعة القادمة';
      case 'overdue':
        return 'متأخر';
      case 'partial':
        return 'مدفوع جزئياً';
      default:
        return status;
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'paid':
        return 'bg-green-100 text-green-800';
      case 'upcoming':
        return 'bg-blue-100 text-blue-800';
      case 'overdue':
        return 'bg-red-100 text-red-800';
      case 'partial':
        return 'bg-yellow-100 text-yellow-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  };

  // Get unique grades for filter
  const grades = ['all', ...Array.from(new Set(students.map((student) => student.grade)))];

  // Sort installments with newest first
  const getSortedInstallments = (installments: Installment[]) => {
    return [...installments].sort((a, b) => {
      // First sort by status (paid last)
      if (a.status === 'paid' && b.status !== 'paid') return 1;
      if (a.status !== 'paid' && b.status === 'paid') return -1;
      
      // Then sort by due date (oldest first for payment order)
      const dateA = new Date(a.dueDate).getTime();
      const dateB = new Date(b.dueDate).getTime();
      return dateA - dateB; // Changed to ascending order (oldest first)
    });
  };

  const toggleSelectInstallment = (installmentId: string) => {
    setSelectedInstallments(prev => ({
      ...prev,
      [installmentId]: !prev[installmentId]
    }));
  };

  const toggleSelectAllInstallments = (studentId: string) => {
    const student = students.find(s => s.id === studentId);
    if (!student) return;

    const isAllSelected = selectAllChecked[studentId] || false;
    const newSelectAllChecked = {
      ...selectAllChecked,
      [studentId]: !isAllSelected
    };
    setSelectAllChecked(newSelectAllChecked);

    // Get all unpaid installments for this student
    const unpaidInstallments = student.installments.filter(i => !i.paidDate);
    const newSelectedInstallments = { ...selectedInstallments };

    unpaidInstallments.forEach(installment => {
      newSelectedInstallments[installment.id] = !isAllSelected;
    });

    setSelectedInstallments(newSelectedInstallments);
  };

  const handleDeleteStudent = async (studentId: string) => {
    if (!window.confirm('هل أنت متأكد من حذف جميع أقساط هذا الطالب؟')) return;
    
    try {
      const student = students.find(s => s.id === studentId);
      if (!student) {
        alert('لم يتم العثور على الطالب');
        return;
      }
      
      // Temporarily unsubscribe from data store updates
      const unsubscribe = dataStore.subscribe(() => {});
      
      // Delete all installments for this student
      const deletePromises = student.installments.map(installment => 
        dataStore.deleteInstallment(installment.id)
      );
      
      await Promise.all(deletePromises);
      
      // Update the UI state directly
      setInstallments(prevInstallments => 
        prevInstallments.filter(inst => inst.studentId !== studentId)
      );
      
      setStudents(prevStudents => 
        prevStudents.filter(s => s.id !== studentId)
      );
      
      setFilteredStudents(prevStudents => 
        prevStudents.filter(s => s.id !== studentId)
      );
      
      // Resubscribe to data store updates
      unsubscribe();
      
    } catch (error) {
      console.error('Error deleting student installments:', error);
      alert('حدث خطأ أثناء حذف أقساط الطالب');
    }
  };

  const handlePaySelectedInstallments = () => {
    const selectedIds = Object.keys(selectedInstallments).filter(id => selectedInstallments[id]);
    if (selectedIds.length === 0) {
      alert('الرجاء اختيار قسط واحد على الأقل');
      return;
    }

    if (!window.confirm(`هل أنت متأكد من تحديث ${selectedIds.length} قسط كمدفوع؟`)) return;

    try {
      // Use the batch operation helper for better performance
      dataStore.performBatchOperation(() => {
        // Mark all selected installments as paid
        for (const id of selectedIds) {
          const installment = dataStore.getInstallment(id);
          if (!installment) continue;
          
          // Update the installment
          dataStore.saveInstallment({
            ...installment,
            paidDate: new Date().toISOString().split('T')[0],
            status: 'paid'
          });
          
          // Update the parent fee
          const fee = dataStore.getFee(installment.feeId);
          if (fee) {
            // Get all installments for this fee
            const allInstallments = dataStore.getInstallments(user?.schoolId, undefined, installment.feeId);
            
            // Calculate total paid amount
            const totalPaid = allInstallments.reduce((sum, inst) => {
              if (inst.paidDate || selectedIds.includes(inst.id)) {
                return sum + inst.amount;
              }
              return sum;
            }, 0);
            
            // Calculate remaining amount after discount
            const totalAmount = fee.amount - fee.discount;
            const remainingAmount = Math.max(0, totalAmount - totalPaid);
            
            // Update fee status
            let updatedStatus: 'paid' | 'partial' | 'unpaid' = 'unpaid';
            if (remainingAmount <= 0) {
              updatedStatus = 'paid';
            } else if (totalPaid > 0) {
              updatedStatus = 'partial';
            }
            
            // Save the updated fee
            dataStore.saveFee({
              ...fee,
              paid: Math.min(totalPaid, totalAmount),
              balance: remainingAmount,
              status: updatedStatus
            });
          }
        }
      });

      // Clear selection
      setSelectedInstallments({});
      setSelectAllChecked({});
      
      alert(`تم تحديث ${selectedIds.length} قسط كمدفوع بنجاح`);
    } catch (error) {
      console.error('Error marking installments as paid:', error);
      alert('حدث خطأ أثناء تحديث الأقساط كمدفوعة');
    }
  };

  const handleCustomPayment = (id: string) => {
    const installment = dataStore.getInstallment(id);
    if (!installment) return;
    
    setSelectedInstallmentId(id);
    setCustomAmount(installment.amount);
    setShowCustomPayment(true);
  };

  const handleCustomPaymentSubmit = () => {
    if (selectedInstallmentId && customAmount > 0) {
      handleMarkAsPaid(selectedInstallmentId, customAmount);
      setShowCustomPayment(false);
      setSelectedInstallmentId(null);
      setCustomAmount(0);
    }
  };

  // Update the handleDeleteInstallment function
  const handleDeleteInstallment = async (id: string) => {
    if (!window.confirm('هل أنت متأكد من حذف هذا القسط؟')) return;
    
    try {
      // Get the installment first to check if it exists
      const installment = dataStore.getInstallment(id);
      if (!installment) {
        alert('لم يتم العثور على القسط');
        return;
      }

      // Temporarily disable notifications to improve performance
      const originalNotifyListeners = dataStore.notifyListeners;
      dataStore.notifyListeners = () => {}; // Replace with no-op function
      
      // Delete the installment
      await dataStore.deleteInstallment(id);
      
      // Restore the original notifyListeners function and trigger a single update
      dataStore.notifyListeners = originalNotifyListeners;
      dataStore.notifyListeners();
      
    } catch (error) {
      console.error('Error deleting installment:', error);
      alert('حدث خطأ أثناء حذف القسط');
    }
  };

  // Update date formatting function
  const formatDate = (date: string) => {
    try {
      const dateObj = new Date(date);
      if (isNaN(dateObj.getTime())) {
        return date; // Return original if invalid date
      }
      
      // Format as DD/MM/YYYY
      return dateObj.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    } catch (error) {
      console.error('Error formatting date:', error);
      return date; // Return original if error
    }
  };

  // Add template handling functions
  const handleTemplateSelect = (templateId: string) => {
    setSelectedTemplate(templateId);
  };

  const handleSendTemplate = async () => {
    if (!selectedInstallmentId) return;
    
    const installment = dataStore.getInstallment(selectedInstallmentId);
    if (!installment) return;
    
    const student = dataStore.getStudent(installment.studentId);
    if (!student) return;

    try {
      let message = '';
      if (selectedTemplate === 'custom') {
        message = customTemplate;
      } else {
        const template = dataStore.getTemplate(selectedTemplate);
        if (!template) return;
        message = template.content;
      }

      // Replace template variables
      message = message
        .replace(/{studentName}/g, installment.studentName)
        .replace(/{amount}/g, installment.amount.toString())
        .replace(/{currency}/g, CURRENCY)
        .replace(/{dueDate}/g, formatDate(installment.dueDate))
        .replace(/{grade}/g, installment.grade || '')
        .replace(/{feeType}/g, getFeeTypeLabel(installment.feeType));

      // Send WhatsApp message
      const encodedMessage = encodeURIComponent(message);
      const phone = student.phone.replace(/\D/g, '');
      const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
      window.open(whatsappUrl, '_blank');

      // Save message to history
      dataStore.saveMessage({
        id: '',
        studentId: installment.studentId,
        studentName: installment.studentName,
        grade: installment.grade,
        parentName: student.parentName,
        phone: student.phone,
        template: selectedTemplate === 'custom' ? 'قالب مخصص' : selectedTemplate,
        message,
        sentAt: new Date().toISOString(),
        status: 'delivered',
        schoolId: user?.schoolId || ''
      });

      setShowTemplateDialog(false);
      setSelectedTemplate('');
      setCustomTemplate('');
      setSelectedInstallmentId(null);
      
      alert(`تم إرسال تذكير عبر الواتساب للطالب ${installment.studentName}`);
    } catch (error) {
      console.error('Error sending WhatsApp message:', error);
      alert('حدث خطأ أثناء إرسال الرسالة');
    }
  };

  // Get all available months from installments
  const getAvailableMonths = (): string[] => {
    // Define all months in Arabic calendar order
    const allMonths = [
      'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
      'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
    ];
    
    // Create a set to track which months have installments
    const monthsWithInstallments = new Set<string>();
    
    students.forEach(student => {
      student.installments.forEach(inst => {
        if (inst.installmentMonth) {
          monthsWithInstallments.add(inst.installmentMonth);
        } else {
          // If installmentMonth is not set, try to determine it from the due date
          try {
            const dueDate = new Date(inst.dueDate);
            const month = allMonths[dueDate.getMonth()];
            monthsWithInstallments.add(month);
          } catch (e) {
            console.error('Error parsing due date for installment month:', e);
          }
        }
      });
    });
    
    // Return all months, always showing all 12 months
    return allMonths;
  };

  // Generate and print monthly installments report
  const generateMonthlyInstallmentsReport = () => {
    // Get all installments that match the current filters
    let filteredInstallments: Installment[] = [];
    
    filteredStudents.forEach(student => {
      filteredInstallments = [...filteredInstallments, ...student.installments];
    });
    
    // Apply additional status filter directly to installments if a specific status is selected
    if (selectedStatus !== 'all') {
      filteredInstallments = filteredInstallments.filter(inst => {
        if (selectedStatus === 'paid') {
          return inst.status === 'paid';
        } else if (selectedStatus === 'unpaid') {
          return inst.status === 'upcoming';
        } else if (selectedStatus === 'overdue') {
          return inst.status === 'overdue';
        } else if (selectedStatus === 'partial') {
          return inst.status === 'partial';
        }
        return true;
      });
    }
    
    if (filteredInstallments.length === 0) {
      alert('لا توجد أقساط مطابقة للفلاتر المحددة');
      return;
    }
    
    // Format the report title based on filters
    let reportTitle = 'تقرير الأقساط';
    if (selectedMonth !== 'all') {
      reportTitle += ` - شهر ${selectedMonth}`;
    }
    
    if (selectedStatus !== 'all') {
      const statusLabels: Record<string, string> = {
        'paid': 'المدفوعة',
        'unpaid': 'غير المدفوعة',
        'overdue': 'المتأخرة',
        'partial': 'المدفوعة جزئياً'
      };
      reportTitle += ` - ${statusLabels[selectedStatus] || ''}`;
    }
    
    if (selectedGrade !== 'all') {
      reportTitle += ` - ${selectedGrade}`;
    }
    
    // Get school settings for footer information
    const schoolSettings = dataStore.getSettings(user?.schoolId || '');
    
    console.log('School settings for report:', {
      schoolId: user?.schoolId,
      name: schoolSettings.name || user?.schoolName,
      email: schoolSettings.email,
      phone: schoolSettings.phone,
      phoneWhatsapp: schoolSettings.phoneWhatsapp,
      phoneCall: schoolSettings.phoneCall,
      hasLogo: !!schoolSettings.logo
    });
    
    // Generate HTML for the report
    const html = generateInstallmentsReportHTML({
      title: reportTitle,
      installments: filteredInstallments,
      schoolName: schoolSettings.name || user?.schoolName || '',
      date: new Date().toLocaleDateString('en-GB'), // Use Georgian date format (DD/MM/YYYY)
      filters: {
        month: selectedMonth !== 'all' ? selectedMonth : 'الكل',
        status: selectedStatus !== 'all' ? getStatusLabel(selectedStatus) : 'الكل',
        grade: selectedGrade !== 'all' ? selectedGrade : 'الكل'
      },
      schoolInfo: {
        email: schoolSettings.email || '',
        phone: schoolSettings.phone || '',
        phoneWhatsapp: schoolSettings.phoneWhatsapp || '',
        phoneCall: schoolSettings.phoneCall || '',
        logo: schoolSettings.logo || user?.schoolLogo || '',
        showLogoBackground: schoolSettings.showLogoBackground
      }
    });
    
    // Open the report in a new window
    const reportWindow = window.open('', '_blank');
    if (reportWindow) {
      reportWindow.document.write(html);
      reportWindow.document.close();
      setTimeout(() => {
        reportWindow.print();
      }, 500);
    }
  };

  // Generate HTML for installments report
  const generateInstallmentsReportHTML = (data: {
    title: string;
    installments: Installment[];
    schoolName: string;
    date: string;
    filters: {
      month: string;
      status: string;
      grade: string;
    },
    schoolInfo: {
      email: string;
      phone: string;
      phoneWhatsapp: string;
      phoneCall: string;
      logo?: string;
      showLogoBackground?: boolean;
    }
  }): string => {
    // Sort installments by status and student name
    const sortedInstallments = [...data.installments].sort((a, b) => {
      // First sort by status
      if (a.status !== b.status) {
        const statusOrder = ['overdue', 'upcoming', 'partial', 'paid'];
        return statusOrder.indexOf(a.status) - statusOrder.indexOf(b.status);
      }
      
      // Then by student name
      return a.studentName.localeCompare(b.studentName);
    });
    
    // Calculate totals
    const totalAmount = sortedInstallments.reduce((sum, inst) => sum + inst.amount, 0);
    const totalPaid = sortedInstallments.reduce((sum, inst) => {
      if (inst.status === 'paid') {
        return sum + inst.amount;
      } else if (inst.status === 'partial' && inst.paidAmount !== undefined) {
        return sum + inst.paidAmount;
      }
      return sum;
    }, 0);
    const totalDue = totalAmount - totalPaid;
    
    // Group installments by status for summary
    const statusCounts = {
      paid: sortedInstallments.filter(inst => inst.status === 'paid').length,
      upcoming: sortedInstallments.filter(inst => inst.status === 'upcoming').length,
      overdue: sortedInstallments.filter(inst => inst.status === 'overdue').length,
      partial: sortedInstallments.filter(inst => inst.status === 'partial').length
    };
    
    // Generate HTML
    return `
      <!DOCTYPE html>
      <html lang="ar" dir="rtl">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>${data.title}</title>
        <style>
          @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
          
          * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
          }
          
          body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding: 20px;
            direction: rtl;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-start;
          }
          
          .report-container {
            width: 210mm;
            max-width: 210mm;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
          }
          
          ${data.schoolInfo.logo ? `
          .logo-background {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            max-width: 500px;
            max-height: 500px;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.12; /* Increased from 0.09 to make more visible */
            z-index: 10;
            pointer-events: none;
          }
          ` : ''}
          
          .report-header {
            background-color: #800000;
            color: white;
            padding: 20px;
            text-align: center;
          }
          
          .report-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
          }
          
          .school-logo {
            max-width: 80px;
            max-height: 80px;
            object-fit: contain;
            margin: 0 auto 10px;
            display: block;
            background-color: rgba(255, 255, 255, 0.8); /* Add white background */
            border-radius: 50%; /* Make it circular for better aesthetics */
            padding: 5px; /* Add some padding */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Add subtle shadow */
          }
          
          .report-info {
            display: flex;
            justify-content: space-between;
            padding: 15px 25px;
            border-bottom: 1px solid #eee;
            background-color: rgba(249, 249, 249, 0.9);
            position: relative;
            z-index: 5;
          }
          
          .filters {
            background-color: rgba(249, 249, 249, 0.9);
            padding: 15px 25px;
            border-bottom: 1px solid #eee;
            position: relative;
            z-index: 5;
          }
          
          .filter-item {
            display: inline-block;
            margin-left: 20px;
            font-size: 14px;
          }
          
          .filter-label {
            font-weight: bold;
            color: #800000;
          }
          
          .summary {
            display: flex;
            justify-content: space-between;
            padding: 15px 25px;
            background-color: rgba(240, 240, 240, 0.9);
            border-bottom: 1px solid #ddd;
            position: relative;
            z-index: 5;
          }
          
          .summary-item {
            text-align: center;
          }
          
          .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: #800000;
          }
          
          .summary-label {
            font-size: 14px;
            color: #666;
          }
          
          table {
            width: 100%;
            border-collapse: collapse;
            position: relative;
            z-index: 5;
          }
          
          th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
            background-color: rgba(255, 255, 255, 0.7);
          }
          
          th {
            background-color: rgba(245, 245, 245, 0.9);
            font-weight: bold;
            color: #800000;
          }
          
          tr:nth-child(even) {
            background-color: rgba(249, 249, 249, 0.7);
          }
          
          tr:hover {
            background-color: rgba(241, 241, 241, 0.9);
          }
          
          .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
          }
          
          .status-paid {
            background-color: #d4edda;
            color: #155724;
          }
          
          .status-upcoming {
            background-color: #cce5ff;
            color: #004085;
          }
          
          .status-overdue {
            background-color: #f8d7da;
            color: #721c24;
          }
          
          .status-partial {
            background-color: #fff3cd;
            color: #856404;
          }
          
          .footer {
            padding: 15px;
            text-align: center;
            font-size: 16px; /* Increased font size from 14px to 16px */
            color: white;
            background-color: #800000;
            border-top: 1px solid #eee;
            margin-top: auto;
            position: relative;
            width: 100%;
          }
          
          .school-contact {
            margin-top: 5px;
            font-size: 16px; /* Increased font size from 13px to 16px */
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            direction: rtl;
            width: 100%;
            box-sizing: border-box;
            padding: 0 10px;
          }
          
          @media print {
            @page {
              size: 210mm 297mm;
              margin: 0;
            }
            
            html, body {
              width: 210mm;
              height: 297mm;
              margin: 0 !important;
              padding: 0 !important;
              background-color: white !important;
              overflow: visible !important;
            }
            
            body {
              display: flex !important;
              justify-content: center !important;
              align-items: flex-start !important;
            }
            
            .report-container {
              position: relative !important;
              width: 210mm !important;
              height: auto !important;
              min-height: 297mm !important;
              margin: 0 auto !important;
              padding: 0 !important;
              box-shadow: none !important;
              border-radius: 0 !important;
              overflow: visible !important;
              page-break-inside: avoid;
            }
            
            .report-header {
              position: sticky !important;
              top: 0 !important;
              z-index: 100 !important;
              page-break-inside: avoid !important;
              page-break-before: avoid !important;
              page-break-after: avoid !important;
            }
            
            .report-info, .filters, .summary {
              page-break-inside: avoid !important;
            }
            
            table {
              page-break-inside: auto !important;
            }
            
            tr {
              page-break-inside: avoid !important;
              page-break-after: auto !important;
            }
            
            thead {
              display: table-header-group !important;
            }
            
            tfoot {
              display: table-footer-group !important;
            }
            
            .no-print {
              display: none !important;
            }
            
            .footer {
              position: sticky !important;
              bottom: 0 !important;
              left: 0 !important;
              width: 100% !important;
              page-break-inside: avoid !important;
              page-break-before: avoid !important;
            }
            
            .school-contact {
              font-size: 14px !important; /* Increased font size in print from 12px to 14px */
              gap: 8px !important;
            }
          }
        </style>
      </head>
      <body>
        <div class="report-container">
          ${data.schoolInfo.logo ? `<div class="logo-background" style="background-image: url('${data.schoolInfo.logo}');"></div>` : ''}
          <div class="report-header">
            ${data.schoolInfo.logo ? `<img src="${data.schoolInfo.logo}" class="school-logo" alt="${data.schoolName}" />` : ''}
            <h1>${data.title}</h1>
            <div>${data.schoolName}</div>
          </div>
          
          <div class="report-info">
            <div>تاريخ التقرير: ${data.date}</div>
            <div>عدد الأقساط: ${sortedInstallments.length}</div>
          </div>
          
          <div class="filters">
            <div class="filter-item">
              <span class="filter-label">الشهر:</span>
              <span>${data.filters.month}</span>
            </div>
            <div class="filter-item">
              <span class="filter-label">الحالة:</span>
              <span>${data.filters.status}</span>
            </div>
            <div class="filter-item">
              <span class="filter-label">الصف:</span>
              <span>${data.filters.grade}</span>
            </div>
          </div>
          
          <div class="summary">
            <div class="summary-item">
              <div class="summary-value">${totalAmount.toLocaleString()} ${CURRENCY}</div>
              <div class="summary-label">إجمالي المبلغ</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${totalPaid.toLocaleString()} ${CURRENCY}</div>
              <div class="summary-label">إجمالي المدفوع</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${totalDue.toLocaleString()} ${CURRENCY}</div>
              <div class="summary-label">إجمالي المستحق</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${statusCounts.paid}</div>
              <div class="summary-label">مدفوع</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${statusCounts.upcoming}</div>
              <div class="summary-label">غير مدفوع</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${statusCounts.overdue}</div>
              <div class="summary-label">متأخر</div>
            </div>
            <div class="summary-item">
              <div class="summary-value">${statusCounts.partial}</div>
              <div class="summary-label">مدفوع جزئياً</div>
            </div>
          </div>
          
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>اسم الطالب</th>
                <th>الصف</th>
                <th>نوع الرسوم</th>
                <th>الشهر</th>
                <th>المبلغ</th>
                <th>الخصم</th>
                <th>تاريخ الاستحقاق</th>
                <th>الحالة</th>
              </tr>
            </thead>
            <tbody>
              ${sortedInstallments.map((inst, index) => {
                const statusClass = `status-${inst.status}`;
                const statusLabel = getStatusLabel(inst.status);
                // Get the fee for this installment to check for discount
                const fee = dataStore.getFee(inst.feeId);
                const discount = fee?.discount || 0;
                
                return `
                  <tr>
                    <td>${index + 1}</td>
                    <td>${inst.studentName}</td>
                    <td>${inst.grade}</td>
                    <td>${getFeeTypeLabel(inst.feeType)}</td>
                    <td>${inst.installmentMonth || '-'}</td>
                    <td>${inst.amount.toLocaleString()} ${CURRENCY}</td>
                    <td>${discount > 0 ? `${discount.toLocaleString()} ${CURRENCY}` : '-'}</td>
                    <td>${formatDate(inst.dueDate)}</td>
                    <td><span class="status ${statusClass}">${statusLabel}</span></td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          
          <div class="footer">
            <div><strong>${data.schoolName}</strong></div>
            <div class="school-contact">
              ${data.schoolInfo.phone ? `<div>هاتف عام: <span dir="ltr">${formatPhoneNumber(data.schoolInfo.phone)}</span></div>` : ''}
              ${data.schoolInfo.phoneWhatsapp ? `<div>واتساب: <span dir="ltr">${formatPhoneNumber(data.schoolInfo.phoneWhatsapp)}</span></div>` : ''}
              ${data.schoolInfo.phoneCall ? `<div>هاتف للاتصال: <span dir="ltr">${formatPhoneNumber(data.schoolInfo.phoneCall)}</span></div>` : ''}
              ${data.schoolInfo.email ? `<div>البريد الإلكتروني: ${data.schoolInfo.email}</div>` : ''}
            </div>
            <div class="no-print">
              <button onclick="window.print()" style="margin-top: 10px; padding: 8px 16px; background-color: #800000; color: white; border: none; border-radius: 4px; cursor: pointer;">
                طباعة التقرير
              </button>
            </div>
          </div>
        </div>
      </body>
      </html>
    `;
  };

  // Add handleDownloadReceipt function
  const handleDownloadReceipt = (id: string) => {
    const installment = installments.find(i => i.id === id);
    if (!installment) return;
    
    const student = dataStore.getStudent(installment.studentId);
    if (!student) return;
    
    // Get school settings
    const schoolSettings = dataStore.getSettings(user?.schoolId || '');
    
    // Generate receipt number
    let receiptNumber = '';
    if (schoolSettings.receiptNumberFormat === 'sequential') {
      receiptNumber = (schoolSettings.receiptNumberCounter || 1).toString().padStart(4, '0');
    } else if (schoolSettings.receiptNumberFormat === 'year') {
      const year = new Date().getFullYear();
      receiptNumber = `${schoolSettings.receiptNumberCounter || 1}/${year}`;
    } else if (schoolSettings.receiptNumberFormat === 'short-year') {
      const year = new Date().getFullYear().toString().slice(-2);
      receiptNumber = `${schoolSettings.receiptNumberCounter || 1}/${year}`;
    } else if (schoolSettings.receiptNumberFormat === 'custom') {
      receiptNumber = `${schoolSettings.receiptNumberPrefix}${schoolSettings.receiptNumberCounter || 1}`;
    } else {
      // Default format (auto)
      receiptNumber = `R-${Date.now().toString().slice(-8)}`;
    }
    
    // Prepare receipt data
    const receiptData = {
      receiptNumber,
      date: formatDate(new Date().toISOString()),
      studentName: student.name,
      studentId: student.studentId,
      grade: student.grade,
      feeType: installment.feeType,
      amount: installment.paidAmount || installment.amount,
      schoolName: schoolSettings.name || user?.schoolName || '',
      schoolLogo: schoolSettings.logo || '',
      schoolPhone: schoolSettings.phone || '',
      schoolPhoneWhatsapp: schoolSettings.phoneWhatsapp || '',
      schoolPhoneCall: schoolSettings.phoneCall || '',
      schoolEmail: schoolSettings.email || '',
      showWatermark: schoolSettings.showReceiptWatermark,
      showLogoBackground: schoolSettings.showLogoBackground
    };
    
    // Increment receipt counter for next time
    if (schoolSettings.receiptNumberFormat !== 'auto') {
      schoolSettings.receiptNumberCounter = (schoolSettings.receiptNumberCounter || 0) + 1;
      dataStore.saveSettings(user?.schoolId || '', schoolSettings);
    }
    
    // Download receipt as PDF
    pdfPrinter.downloadReceiptAsPDF(receiptData);
  };

  if (isLoading) {
    return (
      <div className="h-full flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-800">إدارة الأقساط</h1>
        <div className="flex gap-2">
          <button
            onClick={() => setImportDialogOpen(true)}
            className="btn btn-secondary flex items-center gap-2"
          >
            <Upload size={18} />
            <span>استيراد</span>
          </button>
          <Link to="/school/installments/new" className="btn btn-primary flex items-center gap-2">
            <Plus size={18} />
            <span>إضافة قسط</span>
          </Link>
        </div>
      </div>
      
      <div className="bg-white rounded-lg shadow-md p-4 flex justify-between items-center">
        <div className="flex items-center gap-4">
          <span className="font-bold">عرض:</span>
          <div className="flex border rounded-md overflow-hidden">
            <button
              className={`px-4 py-2 ${displayMode === 'student' 
                ? 'bg-primary text-white' 
                : 'bg-white text-gray-700 hover:bg-gray-100'}`}
              onClick={() => setDisplayMode('student')}
            >
              حسب الطالب
            </button>
            <button
              className={`px-4 py-2 ${displayMode === 'list' 
                ? 'bg-primary text-white' 
                : 'bg-white text-gray-700 hover:bg-gray-100'}`}
              onClick={() => setDisplayMode('list')}
            >
              قائمة الأقساط
            </button>
          </div>
        </div>
        
        <div className="flex flex-wrap gap-2">
          <div className="flex items-center gap-2">
            <Filter size={16} className="text-gray-600" />
            <select
              className="border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-1 focus:ring-primary"
              value={selectedGrade}
              onChange={(e) => setSelectedGrade(e.target.value)}
            >
              <option value="all">جميع الصفوف</option>
              {grades.filter((g) => g !== 'all').map((grade) => (
                <option key={grade} value={grade}>
                  {grade}
                </option>
              ))}
            </select>
          </div>
          
          <div className="flex items-center gap-2">
            <select
              className="border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-1 focus:ring-primary"
              value={selectedStatus}
              onChange={(e) => setSelectedStatus(e.target.value)}
            >
              <option value="all">جميع الحالات</option>
              <option value="paid">مدفوع</option>
              <option value="unpaid">غير مدفوع</option>
              <option value="overdue">متأخر</option>
              <option value="partial">مدفوع جزئياً</option>
            </select>
          </div>
          
          <div className="flex items-center gap-2">
            <Calendar size={16} className="text-gray-600" />
            <select
              className="border border-gray-300 rounded-md px-3 py-1 focus:outline-none focus:ring-1 focus:ring-primary"
              value={selectedMonth}
              onChange={(e) => setSelectedMonth(e.target.value)}
            >
              <option value="all">جميع الشهور</option>
              {getAvailableMonths().map((month) => (
                <option key={month} value={month}>
                  {month}
                </option>
              ))}
            </select>
          </div>
          
          <button
            type="button"
            className="flex items-center gap-1 px-3 py-1 bg-primary-light hover:bg-primary text-white rounded-md transition-colors"
            onClick={generateMonthlyInstallmentsReport}
            title="تنزيل تقرير الأقساط المفلترة"
          >
            <FileText size={16} />
            <span>تقرير</span>
          </button>
          
          <button
            type="button"
            className="flex items-center gap-1 px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md transition-colors"
            onClick={handleExportInstallments}
            title="تصدير قائمة الأقساط كملف CSV مع التلوين"
          >
            <Download size={16} />
            <span>تصدير</span>
          </button>
          
          <button
            type="button"
            className="flex items-center gap-1 px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md transition-colors"
            onClick={() => setImportDialogOpen(true)}
            title="استيراد الأقساط من ملف CSV"
          >
            <Upload size={16} />
            <span>استيراد</span>
          </button>
          
          <button
            type="button"
            className="flex items-center gap-1 px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md transition-colors"
            onClick={() => setDisplayMode(displayMode === 'student' ? 'list' : 'student')}
            title="تغيير طريقة العرض"
          >
            {displayMode === 'student' ? (
              <>
                <CreditCard size={16} />
                <span>عرض القائمة</span>
              </>
            ) : (
              <>
                <User size={16} />
                <span>عرض الطلاب</span>
              </>
            )}
          </button>
        </div>
      </div>
      
      <ImportDialog
        isOpen={importDialogOpen}
        onClose={() => setImportDialogOpen(false)}
        onSuccess={handleImportSuccess}
        templateGenerator={generateInstallmentTemplateCSV}
        templateFileName="قالب_استيراد_الأقساط.csv"
        schoolId={user?.schoolId || ''}
        importType="installments"
      />
      
      {/* Student View Mode */}
      {displayMode === 'student' && (
        <div className="bg-white rounded-lg shadow-md overflow-hidden">
          <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
            <div className="flex items-center gap-2">
              <User size={20} className="text-primary" />
              <h2 className="text-xl font-bold text-gray-800">الأقساط حسب الطالب</h2>
            </div>
            
            {filteredStudents.length > 0 && (
              <div className="flex gap-2">
                <button
                  type="button"
                  className="text-sm px-3 py-1 text-gray-600 hover:text-gray-800"
                  onClick={expandAllStudents}
                >
                  عرض الكل
                </button>
                <button
                  type="button"
                  className="text-sm px-3 py-1 text-gray-600 hover:text-gray-800"
                  onClick={collapseAllStudents}
                >
                  إخفاء الكل
                </button>
              </div>
            )}
          </div>
          
          {filteredStudents.length === 0 ? (
            <div className="p-8 text-center text-gray-500">
              لا يوجد طلبة بالأقساط المحددة
            </div>
          ) : (
            <div className="divide-y divide-gray-200">
              {filteredStudents.map((student) => (
                <div 
                  key={student.id} 
                  className="bg-white rounded-lg shadow-sm border border-gray-100 mb-4"
                >
                  <div 
                    className="p-4 cursor-pointer hover:bg-gray-50 transition-colors"
                    onClick={() => toggleExpandStudent(student.id)}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="flex-1">
                          <h3 className="text-lg font-semibold text-gray-900">{student.name}</h3>
                          <p className="text-sm text-gray-500">{student.grade}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-4">
                        <div className="flex gap-4 text-sm">
                          <div className="text-right">
                            <div className="text-gray-500">الإجمالي</div>
                            <div className="font-medium">{student.totalAmount.toLocaleString()} {CURRENCY}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-gray-500">المدفوع</div>
                            <div className="font-medium text-green-600">{student.totalPaid.toLocaleString()} {CURRENCY}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-gray-500">المتبقي</div>
                            <div className="font-medium text-red-600">{student.totalDue.toLocaleString()} {CURRENCY}</div>
                          </div>
                        </div>
                        
                        <button
                          type="button"
                          onClick={() => handleDeleteStudent(student.id)}
                          className="text-red-500 hover:text-red-700"
                          title="حذف أقساط الطالب"
                        >
                          <Trash2 size={18} />
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  {expandedStudents[student.id] && (
                    <div className="bg-gray-50 p-4">
                      <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200 border rounded-lg bg-white">
                          <thead className="bg-gray-100">
                            <tr>
                              <th scope="col" className="px-4 py-3 text-right">
                                <div className="flex items-center">
                                  <input
                                    type="checkbox"
                                    checked={selectAllChecked[student.id] || false}
                                    onChange={() => toggleSelectAllInstallments(student.id)}
                                    className="h-4 w-4 text-primary rounded"
                                  />
                                  <span className="mr-2 text-xs font-medium text-gray-500 uppercase tracking-wider">تحديد الكل</span>
                                </div>
                              </th>
                              <th scope="col" className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                نوع الرسوم
                              </th>
                              <th scope="col" className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                المبلغ
                              </th>
                              <th scope="col" className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                تاريخ الاستحقاق
                              </th>
                              <th scope="col" className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                شهر القسط
                              </th>
                              <th scope="col" className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                تاريخ الدفع
                              </th>
                              <th scope="col" className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                الحالة
                              </th>
                              <th scope="col" className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                الإجراءات
                              </th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200">
                            {getSortedInstallments(student.installments).map((installment) => (
                              <tr key={installment.id} className="hover:bg-gray-50">
                                <td className="px-4 py-3 whitespace-nowrap">
                                  {!installment.paidDate && (
                                    <input
                                      type="checkbox"
                                      checked={selectedInstallments[installment.id] || false}
                                      onChange={() => toggleSelectInstallment(installment.id)}
                                      className="h-4 w-4 text-primary rounded"
                                    />
                                  )}
                                </td>
                                <td className="px-4 py-3 whitespace-nowrap">
                                  <div className="text-gray-900">{getFeeTypeLabel(installment.feeType)}</div>
                                </td>
                                <td className="px-4 py-3 whitespace-nowrap">
                                  <div className="text-gray-900 font-medium">
                                    {installment.amount.toLocaleString()} {CURRENCY}
                                    {installment.status === 'partial' && installment.paidAmount !== undefined && (
                                      <div className="text-green-500 text-sm">
                                        مدفوع: {installment.paidAmount.toLocaleString()} {CURRENCY}
                                        <div className="text-red-500">
                                          متبقي: {(installment.amount - installment.paidAmount).toLocaleString()} {CURRENCY}
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                </td>
                                <td className="px-4 py-3 whitespace-nowrap">
                                  <div className="text-gray-500">
                                    {formatDate(installment.dueDate)}
                                  </div>
                                </td>
                                <td className="px-4 py-3 whitespace-nowrap">
                                  <div className="text-gray-500">
                                    {installment.installmentMonth || '-'}
                                  </div>
                                </td>
                                <td className="px-4 py-3 whitespace-nowrap">
                                  <div className="text-gray-500">
                                    {installment.paidDate ? formatDate(installment.paidDate) : '-'}
                                  </div>
                                </td>
                                <td className="px-4 py-3 whitespace-nowrap">
                                  <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(installment.status)}`}>
                                    {getStatusLabel(installment.status)}
                                  </span>
                                </td>
                                <td className="px-4 py-3 whitespace-nowrap">
                                  <div className="flex items-center space-x-2 space-x-reverse">
                                    <Link
                                      to={`/school/installments/${installment.id}`}
                                      className="text-primary hover:text-primary-dark"
                                      title="تعديل"
                                    >
                                      <Edit size={16} />
                                    </Link>
                                    
                                    {installment.status !== 'paid' && (
                                      <button
                                        type="button"
                                        onClick={() => handleMarkAsPaid(installment.id)}
                                        className="text-green-600 hover:text-green-800"
                                        title="تحديد كمدفوع"
                                      >
                                        <Check size={16} />
                                      </button>
                                    )}
                                    
                                    {installment.status === 'paid' && (
                                      <div className="flex items-center space-x-1 rtl:space-x-reverse">
                                        <DownloadPrintButtons
                                          onPrint={() => handlePrintReceipt(installment.id)}
                                          onDownload={() => handleDownloadReceipt(installment.id)}
                                          reportType="الإيصال"
                                          showLabels={false}
                                        />
                                      </div>
                                    )}
                                    
                                    {installment.status !== 'paid' && (
                                      <button
                                        type="button"
                                        onClick={() => handleSendReminder(installment.id)}
                                        className="text-blue-600 hover:text-blue-800"
                                        title="إرسال تذكير واتساب"
                                      >
                                        <MessageSquare size={18} />
                                      </button>
                                    )}
                                    
                                    {installment.status !== 'paid' && (
                                      <button
                                        type="button"
                                        onClick={() => handleCustomPayment(installment.id)}
                                        className="text-blue-600 hover:text-blue-800"
                                        title="دفع مبلغ مختلف"
                                      >
                                        <CreditCard size={16} />
                                      </button>
                                    )}
                                    
                                    <button
                                      type="button"
                                      onClick={() => handleDeleteInstallment(installment.id)}
                                      className="text-red-500 hover:text-red-700"
                                      title="حذف القسط"
                                    >
                                      <Trash2 size={16} />
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                      
                      <div className="mt-4 flex justify-between">
                        <div>
                          {Object.keys(selectedInstallments).some(id => selectedInstallments[id]) && (
                            <button
                              type="button"
                              onClick={handlePaySelectedInstallments}
                              className="btn btn-primary flex items-center gap-2 text-sm"
                            >
                              <Check size={16} />
                              <span>تحديد كمدفوع</span>
                            </button>
                          )}
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            type="button"
                            onClick={() => handleDeleteStudent(student.id)}
                            className="text-red-500 hover:text-red-700"
                            title="حذف الرسوم والأقساط"
                          >
                            <Trash2 size={18} />
                          </button>
                          <button
                            type="button"
                            onClick={() => handlePrintStudentReport(student.id)}
                            className="text-gray-600 hover:text-gray-800"
                            title="تنزيل التقرير المالي"
                          >
                            <Download size={18} />
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      )}
      
      {/* List View Mode */}
      {displayMode === 'list' && (
        <div className="bg-white rounded-lg shadow-md overflow-hidden">
          <div className="p-4 bg-gray-50 border-b flex items-center gap-2">
            <CreditCard size={20} className="text-primary" />
            <h2 className="text-xl font-bold text-gray-800">قائمة الأقساط</h2>
          </div>
          
          {installments.length === 0 ? (
            <div className="p-8 text-center text-gray-500">
              لا توجد أقساط مسجلة
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      الطالب
                    </th>
                    <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      الصف
                    </th>
                    <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      نوع الرسوم
                    </th>
                    <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      المبلغ
                    </th>
                    <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      تاريخ الاستحقاق
                    </th>
                    <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      شهر القسط
                    </th>
                    <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      تاريخ الدفع
                    </th>
                    <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      الحالة
                    </th>
                    <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      الإجراءات
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {installments.map((installment) => (
                    <tr key={installment.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="font-medium text-gray-900">{installment.studentName}</div>
                        <div className="text-gray-500 text-sm">{installment.studentId}</div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-gray-500">{installment.grade}</div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-gray-500">{getFeeTypeLabel(installment.feeType)}</div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-gray-900 font-medium">
                          {installment.amount.toLocaleString()} {CURRENCY}
                          {installment.status === 'partial' && installment.paidAmount !== undefined && (
                            <div className="text-green-500 text-sm">
                              مدفوع: {installment.paidAmount.toLocaleString()} {CURRENCY}
                              <div className="text-red-500">
                                متبقي: {(installment.amount - installment.paidAmount).toLocaleString()} {CURRENCY}
                              </div>
                            </div>
                          )}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-gray-500">
                          {formatDate(installment.dueDate)}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-gray-500">
                          {installment.installmentMonth || '-'}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="text-gray-500">
                          {installment.paidDate ? formatDate(installment.paidDate) : '-'}
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(installment.status)}`}>
                          {getStatusLabel(installment.status)}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-left text-sm font-medium flex items-center space-x-2 space-x-reverse">
                        <Link
                          to={`/school/installments/${installment.id}`}
                          className="text-primary hover:text-primary-dark"
                          title="تعديل"
                        >
                          <Edit size={18} />
                        </Link>
                        
                        {installment.status !== 'paid' && (
                          <button
                            type="button"
                            onClick={() => handleMarkAsPaid(installment.id)}
                            className="text-green-600 hover:text-green-800"
                            title="تحديد كمدفوع"
                          >
                            <Check size={18} />
                          </button>
                        )}
                        
                        {installment.status === 'paid' && (
                          <div className="flex items-center space-x-1 rtl:space-x-reverse">
                            <DownloadPrintButtons
                              onPrint={() => handlePrintReceipt(installment.id)}
                              onDownload={() => handleDownloadReceipt(installment.id)}
                              reportType="الإيصال"
                              showLabels={false}
                            />
                          </div>
                        )}
                        
                        {installment.status !== 'paid' && (
                          <button
                            type="button"
                            onClick={() => handleSendReminder(installment.id)}
                            onClick={() => setShowCustomPayment(false)}
                            className="px-4 py-2 text-gray-600 hover:text-gray-800"
                          >
                            إلغاء
                          </button>
                        )}
                        <button
                          type="button"
                          onClick={handleCustomPaymentSubmit}
                          className="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark"
                          disabled={customAmount <= 0}
                        >
                          تأكيد الدفع
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      )}
      
      {showTemplateDialog && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-[600px]">
            <h3 className="text-lg font-semibold mb-4">إدارة قوالب الرسائل</h3>
            
            <div className="mb-4">
              <div className="flex justify-between items-center mb-2">
                <label className="block text-sm font-medium text-gray-700">
                  القوالب المتاحة
                </label>
                <button
                  type="button"
                  onClick={() => {
                    setSelectedTemplate('custom');
                    setCustomTemplate('');
                  }}
                  className="text-sm text-primary hover:text-primary-dark"
                >
                  إضافة قالب جديد
                </button>
              </div>
              
              <div className="space-y-2 max-h-60 overflow-y-auto">
                {dataStore.getTemplates().map(template => (
                  <div key={template.id} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <div>
                      <div className="font-medium">{template.name}</div>
                      <div className="text-sm text-gray-500">{template.content}</div>
                    </div>
                    <div className="flex items-center gap-2">
                      <button
                        type="button"
                        onClick={() => {
                          setSelectedTemplate(template.id);
                          setCustomTemplate(template.content);
                        }}
                        className="text-blue-600 hover:text-blue-800"
                      >
                        <Edit size={16} />
                      </button>
                      <button
                        type="button"
                        onClick={() => {
                          if (window.confirm('هل أنت متأكد من حذف هذا القالب؟')) {
                            dataStore.deleteTemplate(template.id);
                          }
                        }}
                        className="text-red-500 hover:text-red-700"
                      >
                        <Trash2 size={16} />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {selectedTemplate && (
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {selectedTemplate === 'custom' ? 'قالب جديد' : 'تعديل القالب'}
                </label>
                <input
                  type="text"
                  value={customTemplate}
                  onChange={(e) => setCustomTemplate(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary mb-2"
                  placeholder="اسم القالب"
                />
                <textarea
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary"
                  rows={4}
                  value={customTemplate}
                  onChange={(e) => setCustomTemplate(e.target.value)}
                  placeholder="يمكنك استخدام المتغيرات التالية: {studentName}, {amount}, {currency}, {dueDate}, {grade}, {feeType}"
                />
              </div>
            )}

            <div className="flex justify-end gap-2">
              <button
                type="button"
                onClick={() => {
                  setShowTemplateDialog(false);
                  setSelectedTemplate('');
                  setCustomTemplate('');
                }}
                className="px-4 py-2 text-gray-600 hover:text-gray-800"
              >
                إلغاء
              </button>
              {selectedTemplate && (
                <button
                  type="button"
                  onClick={() => {
                    if (customTemplate) {
                      dataStore.saveTemplate({
                        id: selectedTemplate === 'custom' ? uuidv4() : selectedTemplate,
                        name: customTemplate.split('\n')[0] || 'قالب جديد',
                        content: customTemplate
                      });
                      setSelectedTemplate('');
                      setCustomTemplate('');
                    }
                  }}
                  className="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark"
                  disabled={!customTemplate}
                >
                  حفظ
                </button>
              )}
            </div>
          </div>
        </div>
      )}
      
      {showCustomPayment && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 w-96">
            <h3 className="text-lg font-semibold mb-4">دفع مبلغ مختلف</h3>
            
            {selectedInstallmentId && (
              <div className="mb-4">
                <p className="text-gray-600 mb-2">
                  قيمة القسط الأصلية: <span className="font-medium">{dataStore.getInstallment(selectedInstallmentId)?.amount.toLocaleString()} {CURRENCY}</span>
                </p>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  المبلغ المراد دفعه
                </label>
                <input
                  type="number"
                  value={customAmount}
                  onChange={(e) => setCustomAmount(Number(e.target.value))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-primary"
                  min="0"
                  step="0.01"
                />
                {customAmount > 0 && customAmount < (dataStore.getInstallment(selectedInstallmentId)?.amount || 0) && (
                  <p className="text-yellow-600 text-sm mt-1">
                    سيتم تسجيل هذا كدفع جزئي للقسط
                  </p>
                )}
                {customAmount > (dataStore.getInstallment(selectedInstallmentId)?.amount || 0) && (
                  <p className="text-green-600 text-sm mt-1">
                    المبلغ الزائد سيتم تطبيقه على القسط التالي
                  </p>
                )}
              </div>
            )}
            
            <div className="flex justify-end gap-2">
              <button
                type="button"
                onClick={() => setShowCustomPayment(false)}
                className="px-4 py-2 text-gray-600 hover:text-gray-800"
              >
                إلغاء
              </button>
              <button
                type="button"
                onClick={handleCustomPaymentSubmit}
                className="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark"
                disabled={customAmount <= 0}
              >
                تأكيد الدفع
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default Installments;
 
